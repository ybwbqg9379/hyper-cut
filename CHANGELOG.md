# Changelog

All notable changes to this project (forked from HyperCut) will be documented in this file.

## [Unreleased]

### Added

- **Agentic Video Editing**: AI-driven video editing via natural language commands
  - New `src/agent/` module with LLM orchestration layer
  - LM Studio provider (MVP) with Qwen3 VL 8B model support
  - 32 editing tools across 6 categories:
    - Timeline (7): split, split-at-time, delete, duplicate, select-all
    - Playback (7): play/pause, seek, jump, undo/redo
    - Query (4): timeline info, current time, selected elements, duration
    - Media (5): copy, paste, mute, visibility, snapping
    - Scene (7): bookmark, create/switch/list/rename scene, frame stepping
    - Asset (2): list assets, add asset to timeline
  - `AgentChatbox` UI component with provider status indicator
  - Feature-flagged integration via `NEXT_PUBLIC_AGENT_ENABLED`
  - Upstream-safe wrapper pattern (`editor-layout-with-agent.tsx`)
  - Integration tests with Vitest (31 test cases)
  - Vitest configuration (`vitest.config.ts`) with jsdom environment
- **Agent tools扩展（Phase 1）**：新增播放、轨道、选择与导出能力
  - Playback：`seek_to_time`、`set_volume`、`toggle_playback_mute`
  - Timeline：`select_element`、`clear_selection`、`add_track`、`remove_track`、`toggle_track_mute`、`toggle_track_visibility`
  - Project：`export_video`（支持格式/质量/音频参数并触发下载）
- **Agent tools扩展（Phase 2）**：新增转录、文本与时间线编辑能力
  - Transcription：`generate_captions`（支持模型/语言/字幕分块参数）
  - Text：`update_text_style`
  - Timeline：`move_element`、`trim_element`、`resize_element`
  - Project：`update_project_settings`（fps/canvas/background）
- **Agent tools扩展（Phase 3）**：新增变换、静音删除与插入文字能力
  - Transform：`update_element_transform`（scale/position/rotate/opacity）
  - Audio cleanup：`remove_silence`（阈值/最小时长/窗口参数）
  - Text：`insert_text`
- **Agent tools扩展（Upstream补齐）**：新增播放/场景/资产/项目与批量移动能力
  - Playback：`jump_forward`、`jump_backward`、`stop_playback`
  - Scene：`delete_scene`
  - Asset：`add_media_asset`、`remove_asset`
  - Project：`get_project_info`、`save_project`
  - Timeline：`move_elements`
  - Clipboard：`paste_at_time`
- **Agent Planning（Phase 1）**：新增“先计划后执行”的确认式工作流
  - Orchestrator 支持规划模式：先返回工具步骤计划，再由用户确认后执行
  - 支持步骤级编辑/移除：可修改单步参数并重排执行意图
  - Agent 聊天面板新增计划卡片：步骤参数 JSON 编辑、确认执行、取消计划
- **Agent Query 工具增强（Phase 1）**：新增 4 个只读分析工具
  - `get_element_details`
  - `get_elements_in_range`
  - `get_track_details`
  - `get_timeline_summary`
- **转录面板（Phase 2 - MVP）**：新增转录文本与时间线联动视图
  - Agent 面板新增“聊天 / 转录”双视图切换
  - 点击转录段落可跳转到对应时间并联动选中元素
  - 支持文本范围选择并联动多元素选中
  - 支持从转录面板直接删除对应字幕片段
  - 支持逐条编辑字幕文本并一键同步写回时间线元素
  - 转录面板优先使用字幕 metadata 识别 caption（兼容旧 `Caption *` 命名）
  - 新增可选“词级视图”：展示 word-level token，hover 显示时间戳，点击词可跳转并联动对应字幕段
- **工作流引擎（Phase 2）**：新增可复用工作流与 `run_workflow` 执行工具
  - 新增 `list_workflows` / `run_workflow` 两个 Agent 工具
  - 新增预置工作流：`auto-caption-cleanup`、`selection-caption-cleanup`
  - 支持 `stepOverrides` 覆盖指定工作流步骤参数
  - Planning 模式下会将 `run_workflow` 自动展开为逐步计划，确认前可逐步审阅/编辑
  - Agent 面板新增“工作流”视图：选择工作流、编辑 `stepOverrides`、一键发送执行
  - `stepOverrides` 编辑升级为按步骤可视化参数表单，减少手写 JSON 出错
  - 工作流参数编辑新增“恢复本步骤默认 / 恢复全部默认参数”按钮
- **Agent 视觉理解（L3）**：新增浏览器端视频视觉分析链路（无 Python sidecar）
  - Provider：`Message.content` 扩展为多模态 `ContentPart[]`，`lm-studio-provider` 支持 OpenAI 兼容 `image_url` 内容块
  - 新增工具：`detect_scenes`、`analyze_frames`、`suggest_edits`
  - 新增服务：`frame-extractor`（VideoCache 帧采样 + JPEG/base64 编码）与 `scene-detector`（Canvas 像素差分）
  - 转录链路升级为 `segments + words`：Whisper worker 优先请求 `return_timestamps: "word"`，失败回退到 segment 模式
  - `analyze_frames` / `suggest_edits` 已接入 word-level 上下文窗口，优先使用词级时间戳拼接转录文本
  - 支持场景检测结果缓存与帧分析缓存，`analyze_frames` 可复用 `detect_scenes` 的关键帧
  - `run_workflow` 执行映射已接入 Vision 工具类别
- **Agent 资产与贴纸能力补齐（Upstream 对齐）**
  - 新增 `search_sticker`：仅搜索 Iconify 贴纸候选，不直接插入
  - 新增 `add_sticker`：支持 Iconify 搜索并将贴纸插入时间线
  - 新增 `search_sound_effect`：仅搜索 Freesound 音效候选，不直接插入
- **Agent 自动剪辑链路可观测性与恢复能力（Phase 3）**
  - `AgentResponse` 新增 `requestId` / `nextStep` / `resumeHint`，并补全 `awaiting_confirmation` 等状态语义
  - Orchestrator 新增执行事件流：`request_started`、`tool_started`、`tool_completed`、`plan_created`、`request_completed`
  - `run_workflow` 支持前端透传 `startFromStepId` 与 `confirmRequiredSteps`，可从暂停步骤继续执行
  - 统一处理工作流暂停语义：`runWorkflow` 与 `confirmPendingPlan` 遇到确认点时返回 `awaiting_confirmation`
  - Agent 面板新增“执行进度 / 执行轨迹”可视化，以及暂停后“一键继续执行确认步骤”入口
  - 修复 `pendingPlanId` 清理不完整导致的输入阻塞残留问题
  - 新增 orchestrator 覆盖测试：事件流、暂停态传播、恢复参数透传
  - 新增 `add_sound_effect`：支持 `soundId` 直加或按搜索结果添加到时间线
  - 新增 `update_sticker_color`：支持更新贴纸 `color`
  - 扩展 `UpdateElementTransformCommand`：支持 sticker 颜色更新并保留 undo/redo 链路
- **Long-to-Short 工作流（MVP）**：新增长视频转短视频精华链路
  - 新增工具：`score_highlights`、`validate_highlights_visual`、`generate_highlight_plan`、`apply_highlight_cut`
  - 新增服务：`transcript-analyzer`（语义分段 + 规则评分）、`highlight-scorer`（语义/视觉综合评分）、`segment-selector`（时长约束选段）
  - 新增工作流：`long-to-short`（评分 → 视觉验证 → 计划生成 → 应用剪辑）
  - 新增测试：`transcript-analyzer` / `highlight-scorer` / `segment-selector` / `highlight-tools`
- **Long-to-Short 可视化预览（Phase 4）**：新增“生成计划后可视化标注 + 预览播放 + 主编辑区反馈”
  - Timeline 头部新增 `AI 预览` 区间条：绿色保留区间、红色删除区间
  - Preview 面板新增浮层：执行中状态提示、精华预览摘要、`播放预览/停止预览/清除` 控件
  - `AgentChatbox` 新增操作结果 toast：完成/失败/取消/待确认态提示
  - `useAgent` 执行事件同步到全局 `agent-ui-store`，支持主编辑区跨面板反馈
- **Agent 缓存持久化（Phase 4）**：高光评分/计划与转录上下文持久化到 IndexedDB
  - `highlightCacheStore` 增加按项目 hydration + 持久化写回
  - `transcriptContextCache` 增加 IndexedDB 回填与失效清理
  - 非浏览器环境自动降级为内存缓存，不影响测试与 SSR

### Changed

- **Agent UI 统一**: AI 助手面板 header 重构，与编辑器面板风格一致
  - 替换自定义 Button tab 为标准 `Tabs`/`TabsList`/`TabsTrigger` 组件（对齐 `PanelBaseView` 模式）
  - 移除冗余 "AI 助手" 文字标签，简化 Online/Offline 状态为圆点指示器
  - 视图切换从嵌套三元表达式重构为 `TabsContent`
  - 修复 `frame-extractor.test.ts` 中 mock canvas 类型缺失导致的 TS2345 编译错误
- **Agent LM Studio configuration**: Full inference parameter support
  - Configurable via `LMStudioConfig` interface or environment variables
  - Supported parameters: `maxTokens`, `temperature`, `topP`, `topK`, `repeatPenalty`, `stop`
  - Increased default timeouts: LLM request 15s → 120s, tool execution 30s → 60s
  - Environment variables:
    - `NEXT_PUBLIC_LM_STUDIO_TIMEOUT_MS` - Request timeout
    - `NEXT_PUBLIC_LM_STUDIO_MAX_TOKENS` - Max generation tokens (default: 4096)
    - `NEXT_PUBLIC_LM_STUDIO_TEMPERATURE` - Sampling temperature (default: 0.7)
    - `NEXT_PUBLIC_LM_STUDIO_TOP_P` - Nucleus sampling (default: 0.9)
    - `NEXT_PUBLIC_LM_STUDIO_TOP_K` - Top-K sampling (default: 40)
    - `NEXT_PUBLIC_LM_STUDIO_REPEAT_PENALTY` - Repetition penalty (default: 1.1)

### Fixed

- **字幕时间轴错位**: 修复转录时间戳按错误采样率计算导致的字幕整体后移
  - `TranscriptionService` 向 worker 透传解码音频的真实 `sampleRate`
  - Whisper worker 在推理前统一将输入重采样到 `16kHz`，避免 44.1k/48k 音频产生时间比例拉伸
  - `generate_captions`、长视频高光评分与字幕面板共用同一修复链路，确保时间戳一致
- **Long-to-Short 内存占用**: 修复 Safari 因内存过高自动刷新（`this webpage was reloaded because it was using significant memory`）
  - `validate_highlights_visual` 不再将 `thumbnailDataUrl` 写入缓存/计划/返回结果
  - 视觉关键帧统一降采样到最大 `640x360`，降低 base64 体积与峰值内存
  - Agent 编排层对 tool 历史消息做体积裁剪，避免将大 `segments/stepResults` 反复注入对话上下文
  - `run_workflow` 的 `stepResults` 改为轻量摘要（仅 `success/message`）
  - `long-to-short` 工作流视觉验证默认参数下调：`topN 15 → 8`、`frameConcurrency 2`
- **编辑器布局告警刷屏**: 修复 Agent 模式下横向 4 面板默认比例总和不为 100 的问题
  - 对 `tools/preview/properties` 在渲染与持久化时统一做归一化（按 Agent 预留宽度计算）
  - 消除 `Invalid layout total size ... Layout normalization will be applied` 重复告警
- **Agent 工具结果渲染告警**: 修复重复 key 导致的 React warning
  - `AgentChatbox` 的 tool call 列表改为基于 `message.id + index` 生成唯一 key
  - 消除 `Encountered two children with the same key` 控制台告警
- **Long-to-Short 区间越界**: 修复 `score_highlights` 误用跨项目旧转录导致计划时间超出当前时间线
  - 使用 `transcriptionService.getLastResult()` 前先做“转录时间范围 vs 当前时间线时长”对齐校验
  - 对转录 `segments/words` 做时间裁剪与最小时长过滤，避免生成无效区间
  - 无效内存转录将自动回退到当前时间线实时转录或字幕上下文
- **转录缓存鲁棒性**: 修复空转录结果被缓存后导致后续工作流一直提示“无可用转录文本”
  - `score_highlights` / `vision` 的转录上下文缓存不再持久化 `source=none` 空结果
  - 命中空缓存时会清除并重试自动转写，无需先手动生成字幕
- **工具名兼容性**: 增加 `visual_validation` / `visual-validation` 到 `validate_highlights_visual` 的别名映射
  - 避免模型或用户使用变体命名时出现 `Tool not found`
- **Long-to-Short 剪辑生效性**: `apply_highlight_cut` 新增删除后时间线压缩（ripple）与时长校验
  - 删除区间后会将保留片段整体左移，避免出现“有删除但总时长不变”
  - 若实际时长未缩短，将返回 `HIGHLIGHT_CUT_NO_EFFECT`，避免误报“已应用”
  - 删除区间改为直接调用 `editor.timeline.deleteElements`，避免在无 action handler 场景下“提示成功但未实际删除”
  - 新增保留区间有效性校验与“剪空自动回滚”，避免导出时报“Project is empty”
- **计划数据透传**: Orchestrator 对 `generate_highlight_plan` 增加轻量数据下发
  - 向客户端返回压缩后的片段时间区间与计划摘要，避免大 payload
  - 支持前端直接渲染时间线预览区间，不再依赖聊天文本解析
- **Highlight 帧提取可靠性**: 重构视觉验证帧提取链路，修复 4/5 帧空白问题
  - 根因：共享 `videoCache` 单例被编辑器渲染器与 Agent 同时使用，seek 互相干扰导致 canvas 被覆写
  - 新方案：独立 `HTMLVideoElement` + `canvas.drawImage()`，完全绕过共享 videoCache
  - 优化：视频只加载一次（`createFrameExtractor`），多帧复用同一 video 元素（`captureFrameAt`）
  - 加载超时 30s，seek 超时 10s，`canplay` 事件确保视频真正可用
- **Highlight VLM 固定评分**: 重写视觉评分 prompt，消除模型复制示例值的问题
  - 移除 prompt 中的数值示例 `{"frameQuality": 0.8, ...}`，改用 `<分数>` 占位符
  - 新增提示"请根据画面实际内容给出判断，不要固定输出相同分数"
- **Highlight 工具超时**: `DEFAULT_HIGHLIGHT_TOP_N_VISUAL` 15→5 减少帧提取量
- **工作流发送按钮无响应**: `handleRunWorkflow()` 新增 `setActiveView("chat")` 自动切换到聊天视图
- **帧提取并发安全**: `DEFAULT_HIGHLIGHT_FRAME_EXTRACTION_CONCURRENCY` 4→1，避免 VideoCache 并发 seek 竞争
- **项目列表时长显示**: `StorageService` 始终从场景数据计算时长，不依赖可能过期的 metadata.duration
- **Timeline hydration error**: Fixed nested `<button>` elements causing React hydration mismatch
  - Changed outer `<button>` in `TimelineTrackContent` to `<div>` with proper ARIA attributes
  - Added `role="button"`, `tabIndex={0}`, and keyboard event handlers for accessibility
- **Agent code quality**: Fixed lint errors and improved test coverage
  - Resolved TypeScript type errors in fetch mocks
  - Eliminated non-null assertions in tests via `getToolByName()` helper
  - Added trackId parameter tests for `add_asset_to_timeline`
  - Cleaned up unused imports and private class members
- **React version mismatch**: Upgraded `react` from 19.2.0 to 19.2.4 to match `react-dom` version
- **Agent reliability**: Added tool argument parsing safeguards, request timeout, and conversation history limits
- **Agent assets**: Added download timeout/size limits for `add_media_asset` and clarified CORS/network failures
- **Agent tests**: Force-mocked `fetch` to prevent real network calls, added failure-path coverage for asset ingestion
- **Agent actions**: Fail fast when action handlers are unavailable to avoid false success
- **Agent orchestration**: Added multi-step tool-call loop with prompt overrides and safer tool execution handling
- **Agent orchestration**: Treat tool failures as unsuccessful responses and avoid mixed content/tool-call history
- **Agent planning robustness**: Added execution lock, cancellation history symmetry, and required-parameter validation for editable plan steps
- **Agent planning UI safety**: Disabled destructive controls during execution and added JSON payload size guard for step editing
- **Agent tooling**: Added tool execution timeout guardrail
- **Clipboard tooling**: Routed `paste_at_time` through action system to avoid direct store coupling
- **Env examples**: Documented Agent-related environment variables
- **Gemini provider**: Marked unavailable until implementation is complete
- **Caption metadata stability**: `generate_captions` 与资产面板字幕生成均写入结构化 metadata，不再依赖名称前缀作为唯一判定
- **自动保存稳定性**: 关闭/删除项目后若延迟保存触发，不再因无 active project 抛出运行时错误
- **Agent 预览状态一致性**: 修复项目切换与预览播放边界状态问题
  - `EditorProvider` 在 `projectId` 变化与组件卸载时清理 `agent-ui-store`，避免跨项目残留高亮预览与执行进度
  - `PreviewCanvas` 统一 highlight playback 的 epsilon 边界判定，避免相邻区间场景下漏播/跳帧
  - `PreviewCanvas` 卸载时重置 `highlightPreviewPlaybackEnabled`，消除 store 脏状态
  - `vision-tools-core` 统一使用 `isCaptionTextElement()` 判定字幕元素（兼容 metadata 与 legacy 命名）
  - `paste-at-time` action 补充 `args: { time: "number" }` 文档元数据，与其他有参 action 保持一致
- **Agent 执行链路一致性**: 修复暂停/超时/取消链路中的边界行为
  - `orchestrator.process()` 在检测到 `awaiting_confirmation` 后立即停止剩余工具执行，避免继续向模型发起下一轮 tool loop
  - 工具超时时主动中止该工具的 `AbortSignal`，降低“超时后后台继续运行”的状态漂移风险
  - `search_sound_effect` 与 `add_sound_effect` 接入 `context.signal` 与取消返回码，确保用户取消后尽快停止网络与解码流程
  - `seek_forward`/`seek_backward` 增加 seconds 入参校验；`PlaybackManager.seek()` 对非有限时间值增加兜底
- **Agent 执行链路工程化改进**: 收敛取消工具与测试断言，降低误判与维护成本
  - 新增 `agent/utils/cancellation.ts`，统一 `EXECUTION_CANCELLED` 常量、取消检测与取消结果构造逻辑
  - `orchestrator.ts` 与 `asset-tools-core.ts` 改为复用共享取消工具，减少重复实现
  - `search_sound_effect` / `add_sound_effect` 删除 `fetch(..., { signal })` 后紧邻的冗余取消检查，保留关键异步边界检测
  - 超时回归测试改为精确断言 `"aborted by signal"`，避免宽松断言掩盖行为回归

### Changed

- **Re-branding**: OpenCut → HyperCut
  - Replaced all `OpenCut` / `opencut` text references with `HyperCut` / `hypercut`
  - Renamed package namespace `@opencut/*` → `@hypercut/*`
  - Renamed logo directory `logos/opencut/` → `logos/hypercut/`
  - Updated site URL to `https://hypercut.app`

### Removed

- **Blog feature**: Removed Marble CMS integration and all blog-related code
  - Deleted `apps/web/src/app/blog/`
  - Deleted `apps/web/src/lib/blog/`
  - Deleted `apps/web/src/types/blog.ts`
  - Removed `MARBLE_WORKSPACE_KEY` and `NEXT_PUBLIC_MARBLE_API_URL` from env schema
- **Contributors page**: Removed GitHub contributors showcase
  - Deleted `apps/web/src/app/contributors/`
- **RSS feed**: Removed blog RSS feed
  - Deleted `apps/web/src/app/rss.xml/`
- **Sponsors page**: Removed sponsors showcase
  - Deleted `apps/web/src/app/sponsors/`
- **Roadmap page**: Removed OpenCut roadmap
  - Deleted `apps/web/src/app/roadmap/`
- **Legal pages**: Removed (will add custom versions later)
  - Deleted `apps/web/src/app/privacy/`
  - Deleted `apps/web/src/app/terms/`
- **UI cleanup**:
  - Changed homepage headline from "The open source" to "HyperCut"
  - Removed GitHub 40k+ star counter button from header
  - Simplified footer to only show logo + copyright
  - Removed all navigation links (Blog, Contributors, Sponsors, Roadmap, etc.)
